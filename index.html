<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Supabase Group Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; color: #333; display: flex; height: 100vh; }

        /* Sidebar Styles */
        #sidebar {
            width: 250px;
            background-color: #2c3e50; /* Dark blue/grey */
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.hidden {
            transform: translateX(-100%);
            position: absolute; /* Hide completely when collapsed */
        }
        #sidebar-toggle {
            position: absolute;
            top: 20px;
            left: calc(100% + 10px); /* Position outside sidebar */
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 1001; /* Ensure it's above other content */
        }
        #sidebar-toggle.active {
            background-color: #dc3545; /* Red when open, indicating "close" */
        }
        #sidebar h3 { margin-top: 0; color: #ecf0f1; }
        #chat-list { list-style: none; padding: 0; flex-grow: 1; overflow-y: auto; }
        #chat-list li { margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s; }
        #chat-list li:hover { background-color: #34495e; }
        #chat-list li.active { background-color: #007bff; font-weight: bold; }
        #create-chat-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            width: 100%;
        }
        #create-chat-button:hover { background-color: #218838; }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #chat-window {
            border: 1px solid #ddd;
            height: 400px; /* Fixed height for scroll */
            flex-grow: 1; /* Allow it to grow in the column flex */
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; word-wrap: break-word; }
        .message.sent { background-color: #dcf8c6; float: right; clear: both; }
        .message.received { background-color: #ffffff; float: left; clear: both; border: 1px solid #eee; }
        .message strong { color: #075e54; }
        .message .timestamp { font-size: 0.75em; color: #777; display: block; text-align: right; margin-top: 5px; }
        .message img, .message video { max-width: 100%; height: auto; border-radius: 5px; margin-top: 5px; display: block; }
        #message-input-area { display: flex; gap: 10px; margin-top: 10px; /* Adjusted margin */ }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        #send-button, #media-button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: #28a745; color: white; }
        #send-button:hover, #media-button:hover { background-color: #218838; }
        #username-setup { text-align: center; margin-bottom: 20px; }
        #username-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #set-username-button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #set-username-button:hover { background-color: #0056b3; }
        .hidden { display: none; }

        /* Modal for Create Chat */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content input[type="text"], .modal-content textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-content button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
        }
        .modal-content button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <button id="sidebar-toggle">Toggle Sidebar</button>

    <div id="sidebar" class="hidden">
        <h3>Your Group Chats (<span id="chat-count">0</span>)</h3>
        <ul id="chat-list">
            </ul>
        <button id="create-chat-button">Create New Chat</button>
    </div>

    <div class="main-content">
        <div class="container">
            <h1>Welcome to Your Group Chat!</h1>

            <div id="username-setup">
                <p>Please enter your desired username:</p>
                <input type="text" id="username-input" placeholder="Your username">
                <button id="set-username-button">Set Username</button>
            </div>

            <div id="chat-interface" class="hidden">
                <h2 id="chat-name"></h2>
                <div id="chat-window">
                    </div>
                <div id="message-input-area">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <input type="file" id="media-upload" accept="image/*,video/*" class="hidden">
                    <button id="media-button">Attach Media</button>
                    <button id="send-button">Send</button>
                </div>
                <div id="status-message" style="color: red; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="create-chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Create New Group Chat</h2>
            <input type="text" id="new-chat-name" placeholder="Chat Name" required>
            <textarea id="new-chat-description" placeholder="Description (optional)"></textarea>
            <button id="submit-create-chat">Create Chat</button>
            <div id="create-chat-status" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

    <script>
        // --- Supabase Client Declaration ---
        // Declared globally, but assigned only after Supabase library is loaded.
        let supabase;

        // --- DOM Elements ---
        const usernameSetupDiv = document.getElementById('username-setup');
        const usernameInput = document.getElementById('username-input');
        const setUsernameButton = document.getElementById('set-username-button');
        const chatInterfaceDiv = document.getElementById('chat-interface');
        const chatNameElement = document.getElementById('chat-name');
        const chatWindow = document.getElementById('chat-window');
        const messageInput = document.getElementById('message-input');
        const mediaUploadInput = document.getElementById('media-upload');
        const mediaButton = document.getElementById('media-button');
        const sendButton = document.getElementById('send-button');
        const statusMessageDiv = document.getElementById('status-message');

        // Sidebar elements
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const chatCountSpan = document.getElementById('chat-count');
        const chatList = document.getElementById('chat-list');
        const createChatButton = document.getElementById('create-chat-button');

        // Create Chat Modal elements
        const createChatModal = document.getElementById('create-chat-modal');
        const closeButton = createChatModal.querySelector('.close-button');
        const newChatNameInput = document.getElementById('new-chat-name');
        const newChatDescriptionInput = document.getElementById('new-chat-description');
        const submitCreateChatButton = document.getElementById('submit-create-chat');
        const createChatStatusDiv = document.getElementById('create-chat-status');

        // --- Global Variables (for client-side user and chat data) ---
        let localUserId = localStorage.getItem('localUserId');
        let username = localStorage.getItem('username');
        let currentChatId = null; // Will be set when a chat is selected/created
        let realtimeSubscription = null; // To manage the real-time subscription

        // --- Helper Functions ---

        /**
         * Generates a UUID (v4) for client-side user identification.
         * @returns {string} A new UUID string.
         */
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * Displays a message in the chat window.
         * @param {object} messageData - The message object from Supabase.
         */
        function displayMessage(messageData) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const isSender = (messageData.sender_local_user_id === localUserId);
            messageElement.classList.add(isSender ? 'sent' : 'received');

            const senderNameStrong = document.createElement('strong');
            senderNameStrong.textContent = `${messageData.sender_name}: `;
            messageElement.appendChild(senderNameStrong);

            if (messageData.content) {
                const contentSpan = document.createElement('span');
                contentSpan.textContent = messageData.content;
                messageElement.appendChild(contentSpan);
            }

            if (messageData.media_url) {
                const mediaElement = document.createElement(messageData.media_type.startsWith('image') ? 'img' : 'video');
                mediaElement.src = messageData.media_url;
                mediaElement.alt = 'Shared Media';
                if (messageData.media_type.startsWith('video')) {
                    mediaElement.controls = true;
                }
                messageElement.appendChild(mediaElement);
            }

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.textContent = new Date(messageData.created_at).toLocaleTimeString();
            messageElement.appendChild(timestampSpan);

            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to bottom
        }

        /**
         * Loads initial messages for the current chat.
         */
        async function loadMessages(chatId) {
            if (!chatId) {
                chatWindow.innerHTML = '<p>Select a chat or create a new one.</p>';
                return;
            }
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .eq('chat_id', chatId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading messages:', error.message);
                statusMessageDiv.textContent = `Error loading messages: ${error.message}`;
            } else {
                chatWindow.innerHTML = ''; // Clear existing messages
                data.forEach(displayMessage);
            }
        }

        /**
         * Subscribes to real-time changes in the messages table for the current chat.
         */
        function subscribeToMessages(chatId) {
            if (realtimeSubscription) {
                // Ensure we unsubscribe from the previous channel if one exists
                supabase.removeChannel(realtimeSubscription);
            }

            if (!chatId) return; // Don't subscribe if no chat is selected

            realtimeSubscription = supabase
                .channel(`chat_room_${chatId}`) // Unique channel per chat
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` },
                    (payload) => {
                        console.log('New message received!', payload.new);
                        displayMessage(payload.new);
                    }
                )
                .subscribe();
        }

        /**
         * Handles sending a new message (text or media).
         */
        async function sendMessage() {
            if (!localUserId || !username) {
                statusMessageDiv.textContent = 'Please set your username first.';
                return;
            }
            if (!currentChatId) {
                statusMessageDiv.textContent = 'Please select or create a chat first.';
                return;
            }

            let messageContent = messageInput.value.trim();
            let mediaUrl = null;
            let mediaType = null;
            const file = mediaUploadInput.files[0];

            if (file) {
                statusMessageDiv.textContent = 'Uploading media...';
                try {
                    // Path: chat_media/CHAT_ID/local_user_id_timestamp_filename
                    const filePath = `${currentChatId}/${localUserId}_${Date.now()}_${file.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('chat_media')
                        .upload(filePath, file);

                    if (uploadError) {
                        throw uploadError;
                    }

                    const { data: publicUrlData } = supabase.storage
                        .from('chat_media')
                        .getPublicUrl(filePath);

                    mediaUrl = publicUrlData.publicUrl;
                    mediaType = file.type;
                    statusMessageDiv.textContent = ''; // Clear status
                } catch (error) {
                    console.error('Error uploading media:', error.message);
                    statusMessageDiv.textContent = `Error uploading media: ${error.message}`;
                    return;
                }
            }

            if (!messageContent && !mediaUrl) {
                statusMessageDiv.textContent = 'Message cannot be empty.';
                return;
            }

            const { error } = await supabase
                .from('messages')
                .insert({
                    chat_id: currentChatId,
                    sender_local_user_id: localUserId,
                    sender_name: username,
                    content: messageContent || null, // Send null if only media
                    media_url: mediaUrl || null,
                    media_type: mediaType || null
                });

            if (error) {
                console.error('Error sending message:', error.message);
                statusMessageDiv.textContent = `Error sending message: ${error.message}`;
            } else {
                messageInput.value = '';
                mediaUploadInput.value = ''; // Clear file input
                statusMessageDiv.textContent = '';
            }
        }

        /**
         * Ensures the user is a participant in the current chat.
         */
        async function ensureParticipant(chatId) {
            if (!localUserId || !username || !chatId) {
                return;
            }

            const { data, error } = await supabase
                .from('chat_participants')
                .select('*')
                .eq('chat_id', chatId)
                .eq('local_user_id', localUserId);

            if (error) {
                console.error('Error checking participant status:', error.message);
                statusMessageDiv.textContent = `Error checking participant: ${error.message}`;
                return;
            }

            if (data && data.length === 0) {
                // User is not a participant, add them
                const { error: insertError } = await supabase
                    .from('chat_participants')
                    .insert({
                        chat_id: chatId,
                        local_user_id: localUserId,
                        username: username
                    });

                if (insertError) {
                    console.error('Error adding participant:', insertError.message);
                    statusMessageDiv.textContent = `Error adding participant: ${insertError.message}`;
                } else {
                    console.log(`User added to chat participants for chat ${chatId}.`);
                }
            } else {
                console.log(`User is already a participant in chat ${chatId}.`);
            }
        }

        /**
         * Loads chat details (e.g., chat name).
         */
        async function loadChatDetails(chatId) {
            if (!chatId) {
                chatNameElement.textContent = 'No Chat Selected';
                return;
            }
            const { data, error } = await supabase
                .from('group_chats')
                .select('name')
                .eq('id', chatId)
                .single();

            if (error) {
                console.error('Error loading chat details:', error.message);
                statusMessageDiv.textContent = `Error loading chat details: ${error.message}`;
                chatNameElement.textContent = `Chat ID: ${chatId} (Error)`;
            } else if (data) {
                chatNameElement.textContent = `Chat: ${data.name}`;
            } else {
                chatNameElement.textContent = `Chat ID: ${chatId} (Not Found)`;
                statusMessageDiv.textContent = 'Chat not found. Please ensure CHAT_ID is correct or create it.';
            }
        }

        /**
         * Handles switching to a new chat.
         * @param {string} newChatId - The UUID of the chat to switch to.
         */
        async function switchChat(newChatId) {
            if (newChatId === currentChatId) return; // Already in this chat

            currentChatId = newChatId;
            // Update URL hash for the "hashtag link" functionality
            window.location.hash = `#chat/${currentChatId}`;

            // Visually mark the active chat in the sidebar
            document.querySelectorAll('#chat-list li').forEach(li => {
                li.classList.remove('active');
                if (li.dataset.chatId === newChatId) {
                    li.classList.add('active');
                }
            });

            chatWindow.innerHTML = '<p>Loading chat...</p>'; // Show loading state
            statusMessageDiv.textContent = ''; // Clear previous status messages

            await ensureParticipant(currentChatId); // Ensure user is a participant of the new chat
            await loadChatDetails(currentChatId);
            await loadMessages(currentChatId);
            subscribeToMessages(currentChatId); // Subscribe to new chat's messages
            console.log(`Switched to chat: ${currentChatId}`);
        }


        /**
         * Fetches and displays the list of chats the user is a part of.
         */
        async function loadUserChats() {
            if (!localUserId) {
                chatList.innerHTML = '<li>Please set your username to see chats.</li>';
                chatCountSpan.textContent = '0';
                return;
            }

            const { data: participantData, error: participantError } = await supabase
                .from('chat_participants')
                .select('chat_id')
                .eq('local_user_id', localUserId);

            if (participantError) {
                console.error('Error fetching participant chats:', participantError.message);
                return;
            }

            const chatIds = participantData.map(p => p.chat_id);

            if (chatIds.length === 0) {
                chatList.innerHTML = '<li>No chats found. Create one!</li>';
                chatCountSpan.textContent = '0';
                // If no chats, ensure no currentChatId is set and unsubscribe
                currentChatId = null;
                if (realtimeSubscription) {
                    supabase.removeChannel(realtimeSubscription);
                    realtimeSubscription = null;
                }
                loadChatDetails(null); // Clear chat details
                loadMessages(null); // Clear messages
                return;
            }

            const { data: chats, error: chatsError } = await supabase
                .from('group_chats')
                .select('id, name')
                .in('id', chatIds)
                .order('name', { ascending: true });

            if (chatsError) {
                console.error('Error fetching chat details:', chatsError.message);
                return;
            }

            chatList.innerHTML = '';
            chats.forEach(chat => {
                const li = document.createElement('li');
                li.textContent = chat.name;
                li.dataset.chatId = chat.id; // Store chat ID on the element
                li.addEventListener('click', () => switchChat(chat.id));
                chatList.appendChild(li);
            });
            chatCountSpan.textContent = chats.length;

            // If no chat is currently selected, and there are chats available, select the first one.
            // Or if a chat is in the URL hash, prioritize that.
            const urlChatId = window.location.hash.startsWith('#chat/') ? window.location.hash.substring(6) : null;

            if (urlChatId && chats.some(chat => chat.id === urlChatId)) {
                switchChat(urlChatId);
            } else if (!currentChatId && chats.length > 0) {
                switchChat(chats[0].id);
            } else if (currentChatId && !chats.some(chat => chat.id === currentChatId)) {
                 // If the previously active chat is no longer in the user's list (e.g., deleted)
                 // Switch to the first available chat or clear if none
                if (chats.length > 0) {
                    switchChat(chats[0].id);
                } else {
                    currentChatId = null;
                    loadChatDetails(null);
                    loadMessages(null);
                    if (realtimeSubscription) {
                        supabase.removeChannel(realtimeSubscription);
                        realtimeSubscription = null;
                    }
                }
            }
        }

        /**
         * Creates a new group chat.
         */
        async function createNewChat() {
            const chatName = newChatNameInput.value.trim();
            const chatDescription = newChatDescriptionInput.value.trim();

            if (!chatName) {
                createChatStatusDiv.textContent = 'Chat name is required.';
                return;
            }
            if (!localUserId || !username) {
                createChatStatusDiv.textContent = 'Please set your username first.';
                return;
            }

            createChatStatusDiv.textContent = 'Creating chat...';
            try {
                const { data, error } = await supabase
                    .from('group_chats')
                    .insert({ name: chatName, description: chatDescription || null })
                    .select('id'); // Select the ID of the newly created chat

                if (error) throw error;

                const newChatId = data[0].id;
                console.log('New chat created with ID:', newChatId);

                // Automatically add the creator as a participant
                const { error: participantError } = await supabase
                    .from('chat_participants')
                    .insert({ chat_id: newChatId, local_user_id: localUserId, username: username });

                if (participantError) throw participantError;

                createChatStatusDiv.textContent = `Chat created! Link: ${window.location.origin}/#chat/${newChatId}`;
                newChatNameInput.value = '';
                newChatDescriptionInput.value = '';

                // Refresh chat list and switch to the new chat
                await loadUserChats(); // This will refresh the sidebar and trigger switchChat if needed

                // Close modal after a short delay
                setTimeout(() => {
                    createChatModal.style.display = 'none';
                    createChatStatusDiv.textContent = ''; // Clear status for next time
                }, 3000);

            } catch (error) {
                console.error('Error creating chat:', error.message);
                createChatStatusDiv.textContent = `Error creating chat: ${error.message}`;
            }
        }


        // --- Event Listeners ---

        // Set Username button click
        setUsernameButton.addEventListener('click', async () => {
            const enteredUsername = usernameInput.value.trim();
            if (enteredUsername) {
                username = enteredUsername;
                localStorage.setItem('username', username);

                if (!localUserId) {
                    localUserId = generateUUID();
                    localStorage.setItem('localUserId', localUserId);
                }

                usernameSetupDiv.classList.add('hidden');
                chatInterfaceDiv.classList.remove('hidden');
                sidebar.classList.remove('hidden'); // Show sidebar after username is set
                sidebarToggle.classList.remove('hidden'); // Show toggle button
                await initChat();
            } else {
                statusMessageDiv.textContent = 'Please enter a username.';
            }
        });

        // Chat input and send button
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Media attachment
        mediaButton.addEventListener('click', () => {
            mediaUploadInput.click();
        });

        // Sidebar toggle
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebarToggle.classList.toggle('active'); // Change color/state of toggle button
        });

        // Create new chat button (opens modal)
        createChatButton.addEventListener('click', () => {
            createChatModal.style.display = 'flex'; // Use flex to center
        });

        // Close modal button
        closeButton.addEventListener('click', () => {
            createChatModal.style.display = 'none';
            newChatNameInput.value = '';
            newChatDescriptionInput.value = '';
            createChatStatusDiv.textContent = '';
        });

        // Submit create chat button
        submitCreateChatButton.addEventListener('click', createNewChat);


        // --- Initialization on DOM Load ---
        async function initChat() {
            // This function is called after the username is set (or retrieved)
            // It manages the core chat setup.
            await loadUserChats(); // Load chats for the sidebar, which will also handle initial chat selection
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // IMPORTANT: Initialize Supabase client *inside* DOMContentLoaded
            // This ensures Supabase object is available after the library loads.
            const SUPABASE_URL = 'https://ahsrsrkzmphbhecishuc.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA';
            supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Check if user data exists in local storage
            if (localUserId && username) {
                usernameSetupDiv.classList.add('hidden');
                chatInterfaceDiv.classList.remove('hidden');
                sidebar.classList.remove('hidden');
                sidebarToggle.classList.remove('hidden');
                await initChat(); // Initialize chat if user data exists
            } else {
                // User needs to set username, so chat setup remains hidden initially
                sidebar.classList.add('hidden'); // Ensure sidebar is hidden until username is set
                sidebarToggle.classList.add('hidden'); // Hide toggle button too
            }
        });
    </script>
</body>
</html>
