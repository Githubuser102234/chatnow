<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ðŸ“ž Video Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 1em; }
    video { width: 45%; margin: 1%; background: #000; }
    #callUI { display: none; }
    #linkContainer { margin: 1em 0; }
  </style>
</head>
<body>

  <h1>Video Call with Supabase</h1>

  <div id="startUI">
    <button id="createBtn">Create Call</button>
    <p>Or open this page with a #call_id link to join a call.</p>
  </div>

  <div id="linkContainer">
    Share this link:<br>
    <code id="shareLink" style="word-break: break-all;"></code>
  </div>

  <div id="callUI">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://ahsrsrkzmphbhecishuc.supabase.co'
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    function uuid4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11)
        .replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    const startUI = document.getElementById('startUI')
    const createBtn = document.getElementById('createBtn')
    const shareLink = document.getElementById('shareLink')
    const callUI = document.getElementById('callUI')
    const localVid = document.getElementById('localVideo')
    const remoteVid = document.getElementById('remoteVideo')

    let pc
    let callId
    let role
    let remoteDescriptionSet = false
    let pendingCandidates = []

    createBtn.onclick = createCall

    async function createCall() {
      callId = uuid4()
      const { error } = await supabase.from('calls').insert([{ call_id: callId }])
      if (error) {
        alert('Error creating call: ' + error.message)
        return
      }
      location.hash = callId
      shareLink.textContent = location.href
      startUI.style.display = 'none'
      callUI.style.display = 'block'
      role = 'caller'
      startWebRTC()
    }

    async function joinCall(id) {
      callId = id
      shareLink.textContent = location.href
      startUI.style.display = 'none'
      callUI.style.display = 'block'
      role = 'callee'
      startWebRTC()
    }

    async function startWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      })

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        localVid.srcObject = stream
        stream.getTracks().forEach(track => pc.addTrack(track, stream))
      } catch (e) {
        alert('Could not get media: ' + e.message)
        return
      }

      pc.ontrack = event => {
        if (!remoteVid.srcObject) {
          remoteVid.srcObject = new MediaStream()
        }
        remoteVid.srcObject.addTrack(event.track)
      }

      pc.onicecandidate = async ({ candidate }) => {
        if (!candidate) return
        await supabase.from('signaling').insert([{
          call_id: callId,
          sender: role,
          signal_type: 'ice',
          payload: candidate.toJSON()
        }])
      }

      supabase
        .from(`signaling:call_id=eq.${callId}`)
        .on('INSERT', payload => onSignal(payload.new))
        .subscribe()

      if (role === 'caller') {
        const offer = await pc.createOffer()
        await pc.setLocalDescription(offer)
        await supabase.from('signaling').insert([{
          call_id: callId,
          sender: role,
          signal_type: 'offer',
          payload: offer.toJSON()
        }])
      }
    }

    async function onSignal(msg) {
      if (msg.sender === role) return

      switch (msg.signal_type) {
        case 'offer':
          await pc.setRemoteDescription(msg.payload)
          remoteDescriptionSet = true
          const answer = await pc.createAnswer()
          await pc.setLocalDescription(answer)
          await supabase.from('signaling').insert([{
            call_id: callId,
            sender: role,
            signal_type: 'answer',
            payload: answer.toJSON()
          }])
          flushPendingCandidates()
          break

        case 'answer':
          await pc.setRemoteDescription(msg.payload)
          remoteDescriptionSet = true
          flushPendingCandidates()
          break

        case 'ice':
          if (remoteDescriptionSet) {
            try {
              await pc.addIceCandidate(msg.payload)
            } catch (e) {
              console.warn('Error adding ICE:', e)
            }
          } else {
            pendingCandidates.push(msg.payload)
          }
          break
      }
    }

    async function flushPendingCandidates() {
      for (const candidate of pendingCandidates) {
        try {
          await pc.addIceCandidate(candidate)
        } catch (e) {
          console.warn('Failed flushing ICE', e)
        }
      }
      pendingCandidates = []
    }

    window.onload = () => {
      const idFromHash = location.hash.slice(1)
      if (idFromHash) {
        joinCall(idFromHash)
      }
    }
  </script>

</body>
</html>