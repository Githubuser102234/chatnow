<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 45%; margin: 10px; background: black; }
    #status { font-weight: bold; margin: 10px; padding: 6px 12px; background: #444; color: white; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“ž Supabase Video Call</h1>
  <div id="status">Not connected</div>
  <div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <div id="controls">
    <button id="startBtn">Create Call</button>
    <p>Shareable link: <span id="shareLink"></span></p>
  </div>

  <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient('https://ahsrsrkzmphbhecishuc.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA')
const status = document.getElementById('status')
const startBtn = document.getElementById('startBtn')
const shareLink = document.getElementById('shareLink')
const localVideo = document.getElementById('localVideo')
const remoteVideo = document.getElementById('remoteVideo')

let pc, callId, role, pending = []

startBtn.onclick = async () => {
  callId = crypto.randomUUID()
  role = 'caller'
  await supabase.from('calls').insert([{call_id:callId}])
  location.hash = callId
  shareLink.textContent = location.href
  initConnection()
}

window.onload = () => {
  const h = location.hash.slice(1)
  if (h) {
    callId = h
    role = 'callee'
    shareLink.textContent = location.href
    initConnection()
  }
}

async function initConnection(){
  log('Initializing connection as ' + role)
  status.textContent = 'Connectingâ€¦'

  pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }] })
  pc.onicecandidate = e => { if (e.candidate) sendSignal('ice', e.candidate.toJSON()) }

  pc.ontrack = e => {
    if (!remoteVideo.srcObject) remoteVideo.srcObject = new MediaStream()
    remoteVideo.srcObject.addTrack(e.track)
    log('Remote track arrived')
    status.textContent = 'Connected'
  }

  pc.onconnectionstatechange = () => log('Connection state: ' + pc.connectionState)

  const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true})
  localVideo.srcObject = stream
  stream.getTracks().forEach(t=>pc.addTrack(t,stream))

  supabase
    .channel('sig_' + callId)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'signaling',filter:`call_id=eq.${callId}`},payload=> {
      log('Signal received:', payload.new)
      handle(payload.new)
    }).subscribe()

  if (role==='caller') {
    const offer = await pc.createOffer()
    await pc.setLocalDescription(offer)
    sendSignal('offer', offer)
  }
}

async function sendSignal(type, payload){
  await supabase.from('signaling').insert([{call_id:callId,sender:role,type,payload}])
  log('Sent', type)
}

let remoteSet = false
async function handle(msg){
  if(msg.sender===role) return
  log('Handling', msg.type)
  if (msg.type==='offer') {
    await pc.setRemoteDescription(new RTCSessionDescription(msg.payload))
    remoteSet = true
    const ans = await pc.createAnswer()
    await pc.setLocalDescription(ans)
    sendSignal('answer', ans)
  } else if (msg.type==='answer') {
    await pc.setRemoteDescription(new RTCSessionDescription(msg.payload))
    remoteSet = true
    pending.forEach(c=>pc.addIceCandidate(new RTCIceCandidate(c)))
  } else if (msg.type==='ice') {
    if(remoteSet) await pc.addIceCandidate(new RTCIceCandidate(msg.payload))
    else pending.push(msg.payload)
  }
}

function log(...a){ console.log(...a) }
</script>
</body>
</html>