<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ“ž Broadcast/WebRTC Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 1em; }
    video { width: 45%; margin: 10px; background: #000; }
    #status { font-weight: bold; padding: 5px; border-radius: 4px; background: #555; color: #fff; }
  </style>
</head>
<body>
  <h1>Supabase Broadcast WebRTC Call</h1>
  <div id="status">Idle</div><br/>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video><br/>
  <button id="startBtn">Create / Join Call</button>
  <p id="share">Share link: <span id="shareLink"></span></p>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const SUPA_URL = 'https://ahsrsrkzmphbhecishuc.supabase.co'
    const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA'
    const supabase = createClient(SUPA_URL, SUPA_ANON)

    const localVid = document.getElementById('localVideo'),
          remoteVid = document.getElementById('remoteVideo'),
          statusEl = document.getElementById('status'),
          startBtn = document.getElementById('startBtn'),
          shareLink = document.getElementById('shareLink')

    let pc, channel, callId, role, remoteDesc = false, queue = []

    function setStatus(s) {
      statusEl.textContent = s
      const colors = { 'Connected': '#4caf50', 'Disconnected': '#f44336', 'Connecting': '#ff9800', 'Idle': '#555' }
      statusEl.style.backgroundColor = colors[s] || '#555'
    }

    async function init() {
      callId = location.hash.slice(1) || crypto.randomUUID()
      role = location.hash.slice(1) ? 'callee' : 'caller'
      location.hash = callId
      shareLink.textContent = location.href
      startBtn.disabled = true
      setStatus('Connecting')
      setupConn()
    }

    async function setupConn() {
      pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] })
      pc.onicecandidate = e => e.candidate && channel.send({ type:'broadcast', event:'ice', payload:e.candidate.toJSON() })
      pc.ontrack = e => {
        if (!remoteVid.srcObject) remoteVid.srcObject = new MediaStream()
        remoteVid.srcObject.addTrack(e.track)
        setStatus('Connected')
      }
      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') setStatus('Connected')
        else if (['failed','disconnected','closed'].includes(pc.connectionState)) setStatus('Disconnected')
      }

      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true })
      localVid.srcObject = stream
      stream.getTracks().forEach(t=>pc.addTrack(t,stream))

      channel = supabase.channel('call_' + callId, { config:{ broadcast:{ self:false } } })
      channel.on('broadcast', { event:'offer' }, msg => handle('offer', msg.payload))
      channel.on('broadcast', { event:'answer' }, msg => handle('answer', msg.payload))
      channel.on('broadcast', { event:'ice' }, msg => handle('ice', msg.payload))
      await channel.subscribe()

      if (role === 'caller') {
        const offer = await pc.createOffer()
        await pc.setLocalDescription(offer)
        await channel.send({ type:'broadcast', event:'offer', payload: offer })
      }
    }

    async function handle(type, payload) {
      if (type === 'offer' && role === 'callee') {
        await pc.setRemoteDescription(new RTCSessionDescription(payload))
        remoteDesc = true
        const ans = await pc.createAnswer()
        await pc.setLocalDescription(ans)
        await channel.send({ type:'broadcast', event:'answer', payload: ans })
        queue.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)))
      } else if (type === 'answer' && role === 'caller') {
        await pc.setRemoteDescription(new RTCSessionDescription(payload))
        remoteDesc = true
        queue.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)))
      } else if (type === 'ice') {
        if (remoteDesc) await pc.addIceCandidate(new RTCIceCandidate(payload))
        else queue.push(payload)
      }
    }

    startBtn.onclick = init
    window.onload = () => {
      if (location.hash) init()
    }
  </script>
</body>
</html>