<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 45%; margin: 10px; background: black; }
    #status { font-weight: bold; margin: 10px; padding: 6px 12px; background: #444; color: white; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“ž Supabase Video Call</h1>
  <div id="status">Not connected</div>
  <div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <div id="controls">
    <button id="startBtn">Create Call</button>
    <p>Shareable link: <span id="shareLink"></span></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://ahsrsrkzmphbhecishuc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA'
    )

    const startBtn = document.getElementById('startBtn')
    const localVideo = document.getElementById('localVideo')
    const remoteVideo = document.getElementById('remoteVideo')
    const statusText = document.getElementById('status')
    const shareLink = document.getElementById('shareLink')

    let pc, callId, role
    let remoteDescSet = false
    const pendingCandidates = []

    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }

    startBtn.onclick = async () => {
      callId = crypto.randomUUID()
      role = 'caller'
      location.hash = callId
      shareLink.textContent = location.href
      await supabase.from('calls').insert([{ call_id: callId }])
      await setupConnection()
    }

    window.onload = async () => {
      const hash = location.hash.slice(1)
      if (hash) {
        callId = hash
        role = 'callee'
        shareLink.textContent = location.href
        await setupConnection()
      }
    }

    async function setupConnection() {
      setStatus('Connecting...')
      pc = new RTCPeerConnection(config)

      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      localVideo.srcObject = stream
      stream.getTracks().forEach(track => pc.addTrack(track, stream))

      pc.ontrack = e => {
        if (!remoteVideo.srcObject) {
          remoteVideo.srcObject = new MediaStream()
        }
        remoteVideo.srcObject.addTrack(e.track)
        setStatus('Connected')
      }

      pc.onicecandidate = async ({ candidate }) => {
        if (candidate) {
          await supabase.from('signaling').insert([{
            call_id: callId,
            type: 'ice',
            sender: role,
            payload: candidate.toJSON()
          }])
        }
      }

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'connected') {
          setStatus('Connected')
        } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
          setStatus('Disconnected')
        }
      }

      supabase
        .channel('signaling_' + callId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'signaling',
          filter: `call_id=eq.${callId}`
        }, ({ new: data }) => handleSignal(data))
        .subscribe()

      if (role === 'caller') {
        const offer = await pc.createOffer()
        await pc.setLocalDescription(offer)
        await supabase.from('signaling').insert([{
          call_id: callId,
          type: 'offer',
          sender: role,
          payload: offer
        }])
      }
    }

    async function handleSignal({ sender, type, payload }) {
      if (sender === role) return // Ignore own messages

      if (type === 'offer') {
        await pc.setRemoteDescription(new RTCSessionDescription(payload))
        remoteDescSet = true

        const answer = await pc.createAnswer()
        await pc.setLocalDescription(answer)
        await supabase.from('signaling').insert([{
          call_id: callId,
          type: 'answer',
          sender: role,
          payload: answer
        }])
      }

      else if (type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(payload))
        remoteDescSet = true
        pendingCandidates.forEach(async c =>
          await pc.addIceCandidate(new RTCIceCandidate(c))
        )
      }

      else if (type === 'ice') {
        if (remoteDescSet) {
          await pc.addIceCandidate(new RTCIceCandidate(payload))
        } else {
          pendingCandidates.push(payload)
        }
      }
    }

    function setStatus(text) {
      statusText.textContent = text
      statusText.style.background = text === 'Connected' ? 'green' :
                                    text === 'Disconnected' ? 'red' : '#555'
    }
  </script>
</body>
</html>