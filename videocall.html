<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ğŸ™ Supabase-Backed WebRTC Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 45%; margin: 1%; background: #000; }
  </style>
</head>
<body>

  <h1>ğŸ“ Video Call</h1>
  <p>
    Share this link to join:<br>
    <code id="shareLink"></code>
  </p>

  <div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // â€”â€”â€” CONFIG â€”â€”â€”
    const SUPABASE_URL   = 'https://ahsrsrkzmphbhecishuc.supabase.co'
    const SUPABASE_ANON  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoc3Jzcmt6bXBoYmhlY2lzaHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjEwODAsImV4cCI6MjA2NzMzNzA4MH0.CI0EQak2VQJi883JkdtD01XQpvKq8lfXoq4PsvGiapA'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    // â€”â€”â€” UTILS â€”â€”â€”
    function uuid4() {
      // quick-and-dirty UUIDv4
      return ([1e7]+-1e3+-4e3+-8e3+-1e11)
        .replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    // Parse or generate call ID from URL hash:
    let callId = location.hash.slice(1)
    if (!callId) {
      callId = uuid4()
      location.hash = callId
    }
    document.getElementById('shareLink').textContent = location.href

    // Role: first to open is â€œcallerâ€, next is â€œcalleeâ€
    let role = 'caller'

    // WebRTC setup
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    })
    const localVid  = document.getElementById('localVideo')
    const remoteVid = document.getElementById('remoteVideo')

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localVid.srcObject = stream
        stream.getTracks().forEach(t => pc.addTrack(t, stream))
      })

    pc.ontrack = evt => {
      if (!remoteVid.srcObject) {
        remoteVid.srcObject = new MediaStream()
      }
      remoteVid.srcObject.addTrack(evt.track)
    }

    // Send ICE candidates into signaling
    pc.onicecandidate = async ({ candidate }) => {
      if (!candidate) return
      await supabase
        .from('signaling')
        .insert([{ call_id: callId, sender: role, signal_type: 'ice', payload: candidate.toJSON() }])
    }

    // Listen to signaling table
    supabase
      .from(`signaling:call_id=eq.${callId}`)
      .on('INSERT', payload => handleSignal(payload.new))
      .subscribe()

    async function handleSignal(msg) {
      if (msg.sender === role) return

      switch (msg.signal_type) {
        case 'offer':
          await pc.setRemoteDescription(msg.payload)
          role = 'callee'
          document.title = 'Callee â€“ ' + callId
          const answer = await pc.createAnswer()
          await pc.setLocalDescription(answer)
          await supabase.from('signaling').insert([{
            call_id: callId,
            sender: role,
            signal_type: 'answer',
            payload: answer.toJSON()
          }])
          break

        case 'answer':
          await pc.setRemoteDescription(msg.payload)
          break

        case 'ice':
          try {
            await pc.addIceCandidate(msg.payload)
          } catch (e) {
            console.warn('ICE add failed:', e)
          }
          break
      }
    }

    // Kick things off if you're the caller:
    if (role === 'caller') {
      pc.createOffer()
        .then(offer => pc.setLocalDescription(offer).then(() =>
          supabase.from('signaling').insert([{
            call_id: callId,
            sender: role,
            signal_type: 'offer',
            payload: offer.toJSON()
          }])
        ))
    }
  </script>
</body>
</html>
